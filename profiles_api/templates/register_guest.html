{% extends 'base.html' %}
{% block content %}
  <h3>Enter guest's information below to register.</h3>
  <br />
  <form id="guest-registration" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="id_name">Name:</label><br />
    <input type="text" name="name" maxlength="255" required id="id_name" onchange="unlockFile()"><br />
    <label for="id_company">Company:</label><br />
    <input type="text" name="company" maxlength="255" required id="id_company"><br />
    <label for="id_nric_number">Nric / FIN:</label><br />
    <input type="text" name="nric_number" maxlength="255" required id="id_nric_number"><br />
    <div id="validateIcon" class="validateicon"></div><br /><br />
    <label for="id_photo">Photo:</label><br />
    <div class="access-camera">
      <!-- Access the camera -->
      <span id="open-web-cam">Open Camera</span>
      <button data-toggle="modal" data-target="#myModal" id="webcam-open-button" type="button" class="btn btn-default" aria-label="Left Align">
        <span class="glyphicon glyphicon-camera" aria-hidden="true"></span>
      </button>
      <!-- End of Access Camera -->
      <input style="cursor: pointer !important; padding-top: 0 !important;" type="file" name="photo" required id="id_photo">
    </div>
    <p>&nbsp;</p>
    <button id="reg-submit" type="submit">Register</button>
  </form>
  {% if messages %}
  <ul class="messages">
      {% for message in messages %}
      <li id="reg-message-success" {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
  </ul>
  {% endif %}

  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Image Capture</h4>
        </div>
        <div class="modal-body">
          <video width="100%" id="vid-show" autoplay></video><br />
          <input id="vid-take" type="button" value="Take Photo"/>
          <div id="vid-canvas"></div>
        </div>
        <div class="modal-footer">
          <button id="stop" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>

    </div>
  </div>

  <script>

    /* Validate if Name is provided */

    var file_input = document.getElementById('id_photo');
    file_input.disabled = true;
    function unlockFile() {
      var name = document.getElementById('id_name');
      var file_input = document.getElementById('id_photo');
      if (name.value !== "") {
        file_input.disabled = false;
      } else {
        file_input.disabled = true;
      }
    }

    /* Validate NRIC / Fin */

    function validate(ic) {
      var icArray = new Array(9);
      for (i = 0; i < 9; i++) {
        icArray[i] = ic.charAt(i);
      }
      icArray[1] *= 2;
      icArray[2] *= 7;
      icArray[3] *= 6;
      icArray[4] *= 5;
      icArray[5] *= 4;
      icArray[6] *= 3;
      icArray[7] *= 2;
      var weight = 0;
      for (i = 1; i < 8; i++) {
        weight += parseInt(icArray[i]);
      }
      var offset = (icArray[0] == "T" || icArray[0] == "G") ? 4 : 0;
      var temp = (offset + weight) % 11;
      var st = Array("J", "Z", "I", "H", "G", "F", "E", "D", "C", "B", "A");
      var fg = Array("X", "W", "U", "T", "R", "Q", "P", "N", "M", "L", "K");
      var theAlpha;
      if (icArray[0] == "S" || icArray[0] == "T") {
        theAlpha = st[temp];
      } else if (icArray[0] == "F" || icArray[0] == "G") {
        theAlpha = fg[temp];
      }
      return (icArray[8] == theAlpha);
    }


    valIcon = $('#validateIcon');
      $('#id_nric_number').keyup(function() {
        var nric_num = $(this).val();
        nric_num = nric_num.replace(/[^0-9 a-z A-Z]+/g, "").replace(/(^\s||\s$)+/, "").toUpperCase();
        $(this).val(nric_num);
        valIcon.removeClass("valid").attr("title", "Not Valid!");
        if (nric_num.length == 9 && validate(nric_num)) {
           valIcon.addClass("valid").attr("title", "Valid!");
        } else {
          alert('Invalid NRIC/FIN, must provide a correct one.');
          $(this).val("");
        }
      }).click(function() {
        $(this).select();
      });

  </script>

{% endblock %}
